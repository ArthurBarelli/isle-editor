// MODULES //

import React, { Component, PropTypes } from 'react';
import { Button, Panel } from 'react-bootstrap';
import Input from 'general/input';
import NumberInput from 'general/number-input';
import SliderInput from 'general/slider-input';
import { findAllChildren } from 'utils/find-nodes';


// DASHBOARD //

class Dashboard extends Component {

	constructor() {
		super();

		this.handleClick = () => {
			let inputs = findAllChildren( this, Input );
			let args = inputs.map( v => {
				if (
					v instanceof NumberInput ||
					v instanceof SliderInput
				) {
					return parseFloat( v.state.value );
				}
				else {
					return v.state.value;
				}
			});
			if ( this.props.id ) {
				global.ISLE.session.log({
					id: this.props.id,
					type: 'DASHBOARD_CLICK_GENERATE',
					value: args
				});
			}
			this.props.onGenerate( ...args );

			const lesson = window.lesson || global.lesson;
			if ( lesson && !lesson.unmounted ) {
				console.log( 'Update lesson...' );
				lesson.forceUpdate();
			}
		};
	}

	componentDidMount() {
		if ( this.props.autoStart ) {
				this.handleClick();
		}
	}

	render() {
		let self = this;
		let children;
		if ( this.props.autoUpdate ) {
			children = React.Children.map( this.props.children, ( c ) => {
				return React.cloneElement( c, {
					onChange() {
						self.handleClick();
					}
				});
			});
		} else {
			children = this.props.children;
		}

		return (
			<Panel
				className="dashboard"
				bsStyle="info"
				header={<h4>{this.props.title}</h4>}
				style={{
					marginTop: '5px',
					marginBottom: '5px',
					background: 'white',
					maxWidth: '600px',
					margin: '0 auto 10px',
				}}
			>
				<p>{this.props.description}</p>
				{ children }
				{ !this.props.autoUpdate ?
					<Button
						bsStyle="info"
						onClick={this.handleClick}
						style={{
							marginTop: '5px',
							marginBottom: '5px',
							top: '-10px'
						}}
						block
					>{this.props.label}</Button> :
					<span />
				}

			</Panel>
		);
	}
}


// DEFAULT PROPERTIES //

Dashboard.defaultProps = {
	onGenerate: function(){},
	label: 'Generate',
	autoUpdate: false,
	autoStart: true
};


// PROPERTY TYPES //

Dashboard.propTypes = {
	onGenerate: PropTypes.func,
	description: PropTypes.string,
	title: PropTypes.string,
	label: PropTypes.string,
	autoUpdate: PropTypes.bool,
	autoStart: PropTypes.bool
};


// EXPORTS //

export default Dashboard;
